version: '3.4'
services:
  postgres_sonar:
    image: postgres:{{sonar.db_version}}
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
      placement:
        constraints: [node.role == manager]
    environment:
      POSTGRES_PASSWORD: {{sonar.password}}
      POSTGRES_USER: {{sonar.user}}
      POSTGRES_DB: sonar
    volumes:
     - "sonardata:/var/lib/postgresql/data"
    networks:
      - sonar-network     
  sonar:
    image: sonarqube:{{sonar.version}}
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
      placement:
        constraints: [node.role == manager]
    ports:
     - '{{sonar.port}}:9000'
     - '9092:9092'
    environment:
      SONARQUBE_JDBC_USERNAME: {{sonar.user}}
      SONARQUBE_JDBC_PASSWORD: {{sonar.password}}
      SONARQUBE_JDBC_URL: jdbc:postgresql://postgres_sonar:5432/sonar
    volumes:
     - "sonardata:/var/lib/postgresql/data"
    networks:
      - sonar-network   
networks:
  sonar-network:
volumes:
  sonardata: 
